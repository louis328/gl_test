<!DOCTYPE html>
<html>
  <head>
      <title>TEST</title>
      <script src="./src/Script.js" type="module"></script>
      <script type="module">
        console.log("es modules ok");
      </script>
      <script nomodule type=text/javascript>
        console.log("es modules error");
        document.getElementById('message').innerHTML += "<div>ES Modules未対応</div>";
      </script>
      <link rel="stylesheet" href="css/style.css">
  
    <script id="vs_2D" type="x-shader/x-vertex">
      uniform mat4 matrix;
      uniform vec2 UVArray[4];
      attribute vec3 position;
      attribute float textureCoord;
      varying   vec2 vTextureCoord;
      void main(void){
        vTextureCoord.x = UVArray[int(textureCoord)].x;
        vTextureCoord.y = UVArray[int(textureCoord)].y;
        gl_Position = (matrix * vec4(position, 1.0));
      }
    </script>
    <script id="fs_2D" type="x-shader/x-fragment">
      precision mediump float;
      uniform sampler2D texture;
      varying vec2 vTextureCoord;
      void main(void){
        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
        vec4 smpColor = texture2D(texture, vTextureCoord);
        gl_FragColor.rgba = smpColor.rgba;
      }
    </script>
    <script id="vs" type="x-shader/x-vertex">#version 300 es
      in vec3 position;
      in vec3 normal;
      in vec2 texCoord;


      uniform mat4 mMatrix;
      uniform mat4 mvpMatrix;
      uniform mat4 normalMatrix;
      
      out vec3 vPosition;
      out vec3 vNormal;
      out vec2 vTexCoord;
      
      void main(){
          vPosition = (mMatrix * vec4(position, 1.0)).xyz;
          vNormal = (normalMatrix * vec4(normal, 0.0)).xyz;
          vTexCoord = texCoord;
          gl_Position = mvpMatrix * vec4(position, 1.0);
      }
    </script>
    <script id="fs" type="x-shader/x-fragment">#version 300 es
      precision highp float;
      
      uniform vec3 lightVec;
      uniform vec3 eyePosition;
      uniform sampler2D texture2dSampler;
      
      in vec3 vPosition;
      in vec3 vNormal;
      in vec2 vTexCoord;
      
      out vec4 outColor;
      
      void main(){
          vec3 light = -normalize(lightVec);
          vec3 eye = normalize(vPosition - eyePosition);
          vec3 ref = normalize(reflect(eye, vNormal));
          float diffuse = max(dot(light, vNormal) * 0.7 + 0.3, 0.2);
          float specular = max(dot(light, ref), 0.0);
          specular = pow(specular, 20.0);
          vec4 samplerColor = texture(texture2dSampler, vTexCoord);
          outColor = vec4(samplerColor.rgb * diffuse + specular, samplerColor.a);
      }
    </script>
    <script id="vs_skin" type="x-shader/x-vertex">#version 300 es
      in vec3 position;
      in vec3 normal;
      in vec2 texCoord;
      in vec4 jointIndex;
      in vec4 weight;

      uniform mat4 mMatrix;
      uniform mat4 mvpMatrix;
      uniform mat4 normalMatrix;
      uniform mat4 joinMatArray[32];//4*4*32

      out vec3 vPosition;
      out vec3 vNormal;
      out vec2 vTexCoord;
      
      void main(){
          mat4 mat;//スキンメッシュ用
          mat = joinMatArray[int(jointIndex.x)] * weight.x;
          mat += joinMatArray[int(jointIndex.y)] * weight.y;
          mat += joinMatArray[int(jointIndex.z)] * weight.z;
          mat += joinMatArray[int(jointIndex.w)] * weight.w;

          vPosition = (mMatrix * vec4(position, 1.0)).xyz;
          vNormal = (normalMatrix * mat * vec4(normal, 0.0)).xyz;
          vTexCoord = texCoord;
          gl_Position = mvpMatrix * mat * vec4(position, 1.0);
      }
    </script>
    <script id="fs_skin" type="x-shader/x-fragment">#version 300 es
      precision highp float;
      
      uniform vec3 lightVec;
      uniform vec3 eyePosition;
      uniform sampler2D texture2dSampler;
      
      in vec3 vPosition;
      in vec3 vNormal;
      in vec2 vTexCoord;
      
      out vec4 outColor;
      
      void main(){
          vec3 light = -normalize(lightVec);
          vec3 eye = normalize(vPosition - eyePosition);
          vec3 ref = normalize(reflect(eye, vNormal));
          float diffuse = max(dot(light, vNormal) * 0.7 + 0.3, 0.2);
          float specular = max(dot(light, ref), 0.0) * 0.0;//specularをカット
          specular = pow(specular, 20.0);
          vec4 samplerColor = texture(texture2dSampler, vTexCoord);
          outColor = vec4(samplerColor.rgb * diffuse + specular, samplerColor.a);
      }
    </script>
    <script id="vsp" type="x-shader/x-vertex">#version 300 es
      in vec3 position;
      out vec2 vTexCoord;
      void main(){
          vTexCoord = ((position + 1.0) * 0.5).xy;
          gl_Position = vec4(position, 1.0);
      }
    </script>
    <script id="fsp" type="x-shader/x-fragment">#version 300 es
      precision highp float;
      uniform sampler2D texture2dSampler;
      in vec2 vTexCoord;
      out vec4 outColor;
      void main(){
          outColor = texture(texture2dSampler, vTexCoord);
      }
     </script>
  </head>
  <body>
      <div id="canvas">
        <canvas id="mainCanvas"></canvas>
        <canvas id="frontCanvas"></canvas>
        main
      </div>
      <div id="message">message</div>
  </body>
</html>